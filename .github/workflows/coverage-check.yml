name: Coverage Check

on:
  workflow_run:
    workflows: ["Backend CI", "Frontend CI"]
    types: [completed]
    branches: [main, 'ytchou/**']

# Need write permissions to create check runs and post comments
permissions:
  checks: write
  pull-requests: write
  contents: read

jobs:
  coverage-analysis:
    runs-on: ubuntu-latest
    # Only run if the triggering workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Find PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
            });

            if (pulls.length > 0) {
              core.setOutput('number', pulls[0].number);
              core.setOutput('found', 'true');
              console.log(`Found PR #${pulls[0].number}`);
              return pulls[0].number;
            } else {
              core.setOutput('found', 'false');
              console.log('No PR found for this branch');
            }

      - name: Create check run (in progress)
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const check = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Coverage Report',
              head_sha: '${{ github.event.workflow_run.head_sha }}',
              status: 'in_progress',
              started_at: new Date().toISOString(),
              output: {
                title: 'Analyzing coverage...',
                summary: 'Downloading coverage reports and analyzing...'
              }
            });
            core.setOutput('check_id', check.data.id);
            console.log(`Created check run ${check.data.id}`);

      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      # Note: workflow_run already triggers after CI completes.
      # Artifact downloads have continue-on-error so we gracefully handle
      # cases where one CI finished but the other hasn't uploaded yet.

      - name: Download backend coverage artifact
        id: backend-artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: backend-ci.yml
          name: coverage-backend
          path: ./coverage-reports/
          commit: ${{ github.event.workflow_run.head_sha }}
        continue-on-error: true

      - name: Download frontend coverage artifact
        id: frontend-artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: frontend-ci.yml
          name: coverage-frontend
          path: ./coverage-reports/
          commit: ${{ github.event.workflow_run.head_sha }}
        continue-on-error: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Run coverage check
        id: coverage
        run: |
          python scripts/ci/coverage-check.py \
            --backend ./coverage-reports/coverage.xml \
            --frontend ./coverage-reports/coverage-final.json \
            --rules ./scripts/ci/coverage-rules.json \
            --output ./coverage-summary.md
        continue-on-error: true

      - name: Read coverage summary
        id: read-summary
        run: |
          if [ -f ./coverage-summary.md ]; then
            # Read file and escape for GitHub Actions output
            SUMMARY=$(cat ./coverage-summary.md)
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "$SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_summary=true" >> $GITHUB_OUTPUT
          else
            echo "has_summary=false" >> $GITHUB_OUTPUT
            echo "summary=No coverage report generated." >> $GITHUB_OUTPUT
          fi

      - name: Update check run (completed)
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const checkId = ${{ steps.check.outputs.check_id }};
            const coverageResult = '${{ steps.coverage.outcome }}';

            let summary = 'Coverage analysis completed.';
            let title = 'Coverage Report';
            let conclusion = 'success';

            // Read the summary file if it exists
            try {
              summary = fs.readFileSync('./coverage-summary.md', 'utf8');
            } catch (e) {
              summary = 'Could not generate coverage report. Check if coverage artifacts were uploaded.';
              conclusion = 'neutral';
              title = 'Coverage Report (No Data)';
            }

            if (coverageResult === 'failure') {
              conclusion = 'failure';
              title = 'Coverage Check Failed';
            }

            await github.rest.checks.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              check_run_id: checkId,
              status: 'completed',
              conclusion: conclusion,
              completed_at: new Date().toISOString(),
              output: {
                title: title,
                summary: summary.substring(0, 65535) // GitHub limit
              }
            });
            console.log(`Updated check run ${checkId} with conclusion: ${conclusion}`);

      - name: Post PR comment
        if: steps.pr.outputs.found == 'true' && steps.read-summary.outputs.has_summary == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('./coverage-summary.md', 'utf8');
            const prNumber = ${{ steps.pr.outputs.number }};

            // Check for existing coverage comment to update instead of creating new
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## ðŸ“Š Test Coverage Report')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
              console.log(`Updated existing comment ${botComment.id}`);
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
              console.log(`Created new comment on PR #${prNumber}`);
            }
